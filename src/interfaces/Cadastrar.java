package interfaces;

import entidade.Usuário;
import controle.ControleTamanhoTexto;
import static entidade.Usuário.inserirUsuario;
import java.awt.Image;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.net.URL;
import javax.swing.AbstractAction;
import javax.swing.Action;
import javax.swing.InputMap;
import javax.swing.JComponent;
import javax.swing.JOptionPane;
import javax.swing.JRootPane;
import javax.swing.KeyStroke;
import javax.swing.GroupLayout;
import javax.swing.GroupLayout.Alignment;
import javax.swing.LayoutStyle.ComponentPlacement;

/**
 *
 * @author Cassiano Rogério
 */

@SuppressWarnings({ "serial", "unused" })
public class Cadastrar extends javax.swing.JDialog {
/**
     * Creates new form Cadastro
     * @param parent
     * @param modal */
    public Cadastrar(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        URL url = this.getClass().getResource("/images/key 20x20.png");
        Image iconeTitulo = Toolkit.getDefaultToolkit().getImage(url);
        this.setIconImage(iconeTitulo);
        initComponents();
        //Setar o botão Okay como botão padrão da janela
        getRootPane().setDefaultButton(jButtonCadastrar);
        panel_Cadastro.setLayout(null);
        panel_Cadastro.add(panel_Rótulos);
        panel_Rótulos.setLayout(null);
        panel_Rótulos.add(jLabelKey);
        panel_Rótulos.add(jLabelKey_Reentrada);
        panel_Rótulos.add(jLabelUser);
        panel_Cadastro.add(panel_Botões);
        panel_Cadastro.add(panel_Entrada_Valores);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        panel_Cadastro = new javax.swing.JPanel();
        panel_Rótulos = new javax.swing.JPanel();
        panel_Rótulos.setBounds(0, 0, 119, 100);
        jLabelUser = new javax.swing.JLabel();
        jLabelUser.setBounds(61, 11, 52, 28);
        jLabelKey = new javax.swing.JLabel();
        jLabelKey.setBounds(70, 45, 43, 21);
        jLabelKey_Reentrada = new javax.swing.JLabel();
        jLabelKey_Reentrada.setBounds(10, 72, 103, 30);
        panel_Entrada_Valores = new javax.swing.JPanel();
        panel_Entrada_Valores.setBounds(119, 0, 258, 100);
        jFormattedTextFieldUser = new javax.swing.JFormattedTextField();
        jPasswordFieldKey = new javax.swing.JPasswordField();
        jPasswordFieldKey_Reentrada = new javax.swing.JPasswordField();
        panel_Botões = new javax.swing.JPanel();
        panel_Botões.setBounds(0, 106, 377, 25);
        jButtonCancelar = new javax.swing.JButton();
        jButtonCadastrar = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Cadastrar Novo Usuário");

        jLabelUser.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabelUser.setText("Usuário");

        jLabelKey.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabelKey.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jLabelKey.setText("Senha");

        jLabelKey_Reentrada.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabelKey_Reentrada.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jLabelKey_Reentrada.setText("Repita a Senha");

        jFormattedTextFieldUser.setDocument( new ControleTamanhoTexto(30) );
        jFormattedTextFieldUser.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jFormattedTextFieldUserActionPerformed(evt);
            }
        });

        jPasswordFieldKey.setDocument( new ControleTamanhoTexto(30) );
        jPasswordFieldKey.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jPasswordFieldKeyActionPerformed(evt);
            }
        });

        jPasswordFieldKey_Reentrada.setDocument( new ControleTamanhoTexto(30) );
        jPasswordFieldKey_Reentrada.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jPasswordFieldKey_ReentradaActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout gl_panel_Entrada_Valores = new javax.swing.GroupLayout(panel_Entrada_Valores);
        gl_panel_Entrada_Valores.setHorizontalGroup(
        	gl_panel_Entrada_Valores.createParallelGroup(Alignment.LEADING)
        		.addGroup(gl_panel_Entrada_Valores.createSequentialGroup()
        			.addGroup(gl_panel_Entrada_Valores.createParallelGroup(Alignment.LEADING, false)
        				.addComponent(jFormattedTextFieldUser, GroupLayout.DEFAULT_SIZE, 250, Short.MAX_VALUE)
        				.addComponent(jPasswordFieldKey, GroupLayout.DEFAULT_SIZE, 250, Short.MAX_VALUE)
        				.addComponent(jPasswordFieldKey_Reentrada))
        			.addContainerGap(29, Short.MAX_VALUE))
        );
        gl_panel_Entrada_Valores.setVerticalGroup(
        	gl_panel_Entrada_Valores.createParallelGroup(Alignment.TRAILING)
        		.addGroup(gl_panel_Entrada_Valores.createSequentialGroup()
        			.addContainerGap(12, Short.MAX_VALUE)
        			.addComponent(jFormattedTextFieldUser, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
        			.addPreferredGap(ComponentPlacement.UNRELATED)
        			.addComponent(jPasswordFieldKey, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
        			.addGap(11)
        			.addComponent(jPasswordFieldKey_Reentrada, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)
        			.addGap(6))
        );
        panel_Entrada_Valores.setLayout(gl_panel_Entrada_Valores);

        jButtonCancelar.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jButtonCancelar.setMnemonic('a');
        jButtonCancelar.setText("Cancelar");
        jButtonCancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonCancelarActionPerformed(evt);
            }
        });

        jButtonCadastrar.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jButtonCadastrar.setMnemonic('c');
        jButtonCadastrar.setText("Cadastrar");
        jButtonCadastrar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonCadastrarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout gl_panel_Botões = new javax.swing.GroupLayout(panel_Botões);
        gl_panel_Botões.setHorizontalGroup(
        	gl_panel_Botões.createParallelGroup(Alignment.TRAILING)
        		.addGroup(gl_panel_Botões.createSequentialGroup()
        			.addGap(173)
        			.addComponent(jButtonCadastrar)
        			.addPreferredGap(ComponentPlacement.RELATED)
        			.addComponent(jButtonCancelar)
        			.addGap(6))
        );
        gl_panel_Botões.setVerticalGroup(
        	gl_panel_Botões.createParallelGroup(Alignment.LEADING)
        		.addGroup(gl_panel_Botões.createSequentialGroup()
        			.addGroup(gl_panel_Botões.createParallelGroup(Alignment.BASELINE)
        				.addComponent(jButtonCancelar)
        				.addComponent(jButtonCadastrar))
        			.addGap(0, 0, Short.MAX_VALUE))
        );
        panel_Botões.setLayout(gl_panel_Botões);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        layout.setHorizontalGroup(
        	layout.createParallelGroup(Alignment.LEADING)
        		.addGroup(layout.createSequentialGroup()
        			.addComponent(panel_Cadastro, GroupLayout.PREFERRED_SIZE, 371, GroupLayout.PREFERRED_SIZE)
        			.addContainerGap(42, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
        	layout.createParallelGroup(Alignment.LEADING)
        		.addGroup(layout.createSequentialGroup()
        			.addGap(10)
        			.addComponent(panel_Cadastro, GroupLayout.PREFERRED_SIZE, 132, GroupLayout.PREFERRED_SIZE)
        			.addContainerGap(22, Short.MAX_VALUE))
        );
        getContentPane().setLayout(layout);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButtonCancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonCancelarActionPerformed
        //Encerra a janela
        this.dispose();
    }//GEN-LAST:event_jButtonCancelarActionPerformed

    private void jButtonCadastrarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonCadastrarActionPerformed
        int forçaSenha;
        String mensagem;
        //Captura os dados digitados pelo usuário
        Usuário dadosbusca;
        // Recebe os dados do usuário que deverá ser cadastrado no sistema
        Usuário dados = capturaNomeSenha();
        if(dados!=null){
            //Checar se o usúario já foi cadastrado no banco de dados
            dadosbusca =  Usuário.Checar_Cadastro_de_Usuário_e_PK(dados.getusuário());
            if (dadosbusca != null) {
                JOptionPane.showMessageDialog(this, "Este usuário já existe!\nConsidere um usuário diferente.", "Atenção",
                        JOptionPane.ERROR_MESSAGE);
            }
            else if (dadosbusca ==null) {
                //Testa a força da senha
                forçaSenha = entidade.Senha.testar_Forca_Da_Senha(dados.getsenha());
                if (forçaSenha >= 4) {
                    if ((dados.getsenha().length()) >= 8) {
                        //Gera uma chave de criptografia automática
                        dados.setChave(entidade.Senha.gerador_de_chave_de_criptografia(16));
                        //Prepara a chave para criptografar os dados, e encripta a senha digitada em MD5
                        dados = prepararDadosparaArmazenar(dados);
                        //realiza a inserção dos dados informados no banco de dados
                        mensagem = inserirUsuario(dados);
                        //Caso o retorno for null o usur foi cadastrado com sucesso, caso contrário algum erro ocorreu durante a inserção
                        if (mensagem==null) {
                            JOptionPane.showMessageDialog(this,
                                    "Usuário " + dados.getusuário() + " cadastrado com sucesso.", "Atenção",
                                    JOptionPane.WARNING_MESSAGE);
                            limparCampos();
                            this.dispose();
                        }
                        else{
                            JOptionPane.showMessageDialog(this, mensagem, "Atenção", JOptionPane.ERROR_MESSAGE);
                        }
                    }
                    else{
                        JOptionPane.showMessageDialog(this,
                            "Sua senha não possui os pré-requisitos de uma senha segura."
                                + "\n\nUse caracteres maiúsculos, minúsculos, números\ne caracteres especiais, e mais de 8 caracteres."
                                + "\nPor exemplo: *>F5s3nh@<*"
                                + "\n\nForça: " + forçaSenha +", INSEGURA, quantidade de caracteres inferior a 8.", "Quantidade de caracteres insuficiente", JOptionPane.WARNING_MESSAGE);
                    }
                }
                else {
                    if(forçaSenha <= 1){
                    JOptionPane.showMessageDialog(this,
                            "Sua senha não possui os pré-requisitos de uma senha segura."
                                + "\n\nUse caracteres maiúsculos, minúsculos, números\ne caracteres especiais, e mais de 8 caracteres."
                                + "\nPor exemplo: *>F5s3nh@<*"
                                + "\n\nForça: " + forçaSenha +", INSEGURA", "Senha Insegura", JOptionPane.WARNING_MESSAGE);
                    }
                    else if(forçaSenha == 2){
                        JOptionPane.showMessageDialog(this, 
                                "Sua senha ainda não é tão boa."
                                    + "\n\nUse caracteres maiúsculos, minúsculos, números\ne caracteres especiais, e mais de 8 caracteres."
                                    + "\nPor exemplo: *>F5s3nh@<*"
                                    + "\n\nForça: " + forçaSenha +", REGULAR", "Senha REGULAR", JOptionPane.WARNING_MESSAGE);
                    }
                    else if(forçaSenha == 3){
                        JOptionPane.showMessageDialog(this, 
                                "Sua senha é boa, porém ainda deve ser mais forte."
                                    + "\n\nUse caracteres maiúsculos, minúsculos, números\ne caracteres especiais, e mais de 8 caracteres."
                                    + "\nPor exemplo: *>F5s3nh@<*"
                                    + "\n\nForça: " + forçaSenha +", BOA", "Senha Boa", JOptionPane.WARNING_MESSAGE);
                    }
                }
            }
        }
    }//GEN-LAST:event_jButtonCadastrarActionPerformed

    private void jPasswordFieldKeyActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jPasswordFieldKeyActionPerformed
        //Pula para o campo de senha
        jPasswordFieldKey_Reentrada.requestFocus();
    }//GEN-LAST:event_jPasswordFieldKeyActionPerformed

    private void jFormattedTextFieldUserActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jFormattedTextFieldUserActionPerformed
        //Pula para o campo de senha
        jPasswordFieldKey.requestFocus();
    }//GEN-LAST:event_jFormattedTextFieldUserActionPerformed

    private void jPasswordFieldKey_ReentradaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jPasswordFieldKey_ReentradaActionPerformed
        //Quando estiver no campo de reentrada da senha permite executar o botão cadastrar com o uso da tecla enter
        jButtonCadastrar.doClick();
    }//GEN-LAST:event_jPasswordFieldKey_ReentradaActionPerformed

    //Permitir fechar a Janela com a tecla Esc
    @Override
    protected JRootPane createRootPane() {
        JRootPane rootPane = new JRootPane();
        KeyStroke stroke = KeyStroke.getKeyStroke("ESCAPE");
        Action actionListener;
        actionListener = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent actionEvent) { 
                setVisible(false);
            } 
        };
        InputMap inputMap = rootPane.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);
        inputMap.put(stroke, "ESCAPE");
        rootPane.getActionMap().put("ESCAPE", actionListener);
        return rootPane;
    }
    
    public Usuário prepararDadosparaArmazenar(Usuário dados){
        //Criptografa a senha escolhida em MD5
        dados.setsenha(entidade.EncriptaSenha_SHA256.encripta(dados.getsenha()));
        
        dados.setChave(geraChaveEncriptação(dados));
        return dados;
    }
    
    public String geraChaveEncriptação(Usuário dados){
        //Caso o nome de user tenha mais de 16 caracteres, os primeiros 16 serão utilizados como chave de criptográfia
        if (dados.getusuário().length()>16) {
            String chave = dados.getusuário().substring(0,16);
            return chave;
        }
        //Se o nome de user for menor que 16 caracteres, irá criar uma chave concatenado com o nome de user com 16 caracteres
        else if(dados.getusuário().length()<16){
            String user, chave, chaveNew;
            int tamanho;
            //Recebe o nome de usuário
            user = dados.getusuário();
            //Recebe a chave
            chave = dados.getChave();
            //Armazena o tamanho da variavel user
            tamanho = user.length();
            //Recebe o final da string chave com os caracteres que faltam para completar os dados para gerar a chave de criptografia
            chave = chave.substring(tamanho, 16);
            chaveNew = user+chave;
            return chaveNew;
        }
        //Se o nome de user tiver 16 caracteres ele poderá ser utilizado como chave de criptográfia
        //if (dados.getusuário().length()==16) 
        return dados.getusuário();
    }
    
    public Usuário capturaNomeSenha(){
        //Usuário dados = null;
        Usuário dados = new Usuário(null,null,null);
        
        //Captura o nome de usuário digitado
        dados.setusuário(jFormattedTextFieldUser.getText());
        //Converte os dados de usuário para caixa baixa(minusculo)
        dados.setusuário(dados.getusuário().toLowerCase());
        
        //Captura a senha digitada
        char[] PassWord =  jPasswordFieldKey.getPassword();
        //Converte a senha em String
        dados.setsenha(String.valueOf(PassWord));
        
        //Captura a senha que foi reinformada para teste
        PassWord = null;
        PassWord =  jPasswordFieldKey_Reentrada.getPassword();
        //Converte a senha em String
        dados.setChave(String.valueOf(PassWord));
        
        //Testa se todos os campos foram informados, caso não retorna um aviso ao user e null
        if ((dados.getusuário().isEmpty()==true) && (dados.getsenha().isEmpty()==true) && (dados.getChave().isEmpty()==true)) {
            JOptionPane.showMessageDialog(this, "Informe os dados do usuário que deseja cadastrar.", "Atenção", JOptionPane.ERROR_MESSAGE);
            return null;
        }
        //Testa cada um dos itens
        else{
            if (dados.getusuário().isEmpty()==true) {
            JOptionPane.showMessageDialog(this, "Informe o nome de Usuário.", "Atenção", JOptionPane.ERROR_MESSAGE);
            }
            if (dados.getsenha().isEmpty()==true) {
                JOptionPane.showMessageDialog(this, "Informe a senha.", "Atenção", JOptionPane.ERROR_MESSAGE);
            }
            if (dados.getChave().isEmpty()==true) {
                JOptionPane.showMessageDialog(this, "Reinforme a senha.", "Atenção", JOptionPane.ERROR_MESSAGE);
            }
            //Se ambas as senhas forem digitadas irá testar se as senhas são iguais, caso contrário retorna null
            if ((dados.getsenha().isEmpty()==false) && (dados.getChave().isEmpty()==false)) {
                //Testa se as senhas são as mesmas, caso contrário emite um erro
                if (dados.getsenha().equals(dados.getChave())==true) {
                    dados.setsenha(dados.getsenha());
                }
                else{
                    JOptionPane.showMessageDialog(this, "Senhas não conferem!", "Atenção", JOptionPane.ERROR_MESSAGE);
                    return null;
                }
            }
            else{
                return null;
            }
        }
        //Gera uma chave de criptografia automática
        dados.setChave(entidade.Senha.gerador_de_chave_de_criptografia(16));
        return dados;
    }
    
    public void limparCampos(){
        jFormattedTextFieldUser.setText("");
        jPasswordFieldKey.setText("");
        jPasswordFieldKey_Reentrada.setText("");
        // Seta o foco no primeiro campo de texto(usuário)
        jFormattedTextFieldUser.requestFocus();
    }
    
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Windows".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(Cadastrar.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(Cadastrar.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(Cadastrar.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(Cadastrar.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                Cadastrar dialog = new Cadastrar(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButtonCadastrar;
    private javax.swing.JButton jButtonCancelar;
    private javax.swing.JFormattedTextField jFormattedTextFieldUser;
    private javax.swing.JLabel jLabelKey;
    private javax.swing.JLabel jLabelKey_Reentrada;
    private javax.swing.JLabel jLabelUser;
    private javax.swing.JPanel panel_Botões;
    private javax.swing.JPanel panel_Cadastro;
    private javax.swing.JPanel panel_Entrada_Valores;
    private javax.swing.JPanel panel_Rótulos;
    private javax.swing.JPasswordField jPasswordFieldKey;
    private javax.swing.JPasswordField jPasswordFieldKey_Reentrada;
    // End of variables declaration//GEN-END:variables
}
